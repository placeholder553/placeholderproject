<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="text-xl font-bold text-gray-800">Chat</div>
      <nav class="space-x-4">
        <a href="/" class="text-gray-700 hover:text-blue-500 font-medium">Home</a>
        <a href="/register" class="text-gray-700 hover:text-blue-500 font-medium">Register</a>
        <a href="/login" class="text-gray-700 hover:text-blue-500 font-medium">Login</a>
      </nav>
    </div>
  </header>

  <!-- Chat Container -->
  <main class="flex-grow py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md overflow-hidden flex flex-col h-[36rem]">

      <!-- Chat Header -->
      <div class="bg-blue-600 text-white p-4 font-semibold">
        {{ recipient_username }}
      </div>

      <!-- Chat Messages -->
      <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
        <!-- Messages go here -->
      </div>

      <!-- Chat Input -->
      <div class="border-t border-gray-200 p-4 space-y-2">
        <input
          id="chat-input"
          type="text"
          placeholder="Type your message..."
          class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        />
        <div class="flex items-center justify-between">
          <input id="image-input" type="file" accept="image/*" class="text-sm text-gray-500" />
          <button id="send-button"
            class="ml-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">
            Send
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Chat Script -->
  <script>
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/{{ recipient_username }}/');

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const message = data['message'];
      const sender = data['sender'];
      const imageData = data['image'];
      const chatBox = document.getElementById('chat-box');

      const messageElement = document.createElement('div');
      const messageContent = document.createElement('div');
      const meta = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      meta.classList.add('text-xs', 'text-gray-500', 'mt-1');

      if (sender === "{{ request.user.username }}") {
        messageElement.classList.add('flex', 'justify-end');
        messageContent.classList.add('inline-block', 'bg-indigo-600', 'text-white', 'px-4', 'py-2', 'rounded-lg', 'max-w-xs', 'break-words');
        meta.classList.add('text-right');
      } else {
        messageElement.classList.add('flex', 'justify-start');
        messageContent.classList.add('inline-block', 'bg-gray-300', 'text-gray-900', 'px-4', 'py-2', 'rounded-lg', 'max-w-xs', 'break-words');
      }

      if (imageData) {
        const img = document.createElement('img');
        img.src = imageData;
        img.classList.add('max-w-xs', 'rounded', 'mb-1');
        messageContent.innerHTML = `[${sender}]:<br/>`;
        messageContent.appendChild(img);
      } else {
        messageContent.textContent = `[${sender}]: ${message}`;
      }

      meta.textContent = timestamp;

      const wrapper = document.createElement('div');
      wrapper.appendChild(messageContent);
      wrapper.appendChild(meta);

      messageElement.appendChild(wrapper);
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    document.getElementById('send-button').addEventListener('click', async function () {
      const messageInput = document.getElementById('chat-input');
      const imageInput = document.getElementById('image-input');

      const message = messageInput.value.trim();
      const file = imageInput.files[0];

      if (!message && !file) return;

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          chatSocket.send(JSON.stringify({
            'message': message,
            'image': e.target.result
          }));
        };
        reader.readAsDataURL(file);
      } else {
        chatSocket.send(JSON.stringify({ message }));
      }

      messageInput.value = '';
      imageInput.value = '';
    });

    document.getElementById('chat-input').addEventListener('keyup', function (e) {
      if (e.key === 'Enter') {
        document.getElementById('send-button').click();
      }
    });
  </script>
</body>
</html>
